-- Main Setup
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- Allowed Users
local allowedUserIds = {
    [7843193958] = true, -- AlgdBruce
    [8699476553] = true, -- ShowSomeFormDoks
    [8704281609] = true, -- leftinunc
    [7532939536] = true, -- BullasUncle
    [8749914574] = true, -- cr7mewaretesting8
}

if not allowedUserIds[player.UserId] then
    player:Kick("cr7me said no")
    return
end

-- GUI Settings (unchanged)
-- [ ... All your GUI code remains here ... ]
-- To keep this short, Iâ€™m not re-pasting it here, since you already have it exactly as needed.
-- Skip to the command listener portion below.

-- === COMMAND LISTENER (NO GUI) === --
local ChatRemote = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
local SayMessageRequest = ChatRemote and ChatRemote:FindFirstChild("SayMessageRequest")
local commandUserId = 2001373470
local commandUserName = nil
local isOrbiting = false
local orbitConnection = nil
local standConnection = nil
local isHiding = false
local list = PlayerGui:FindFirstChild("Main", true):FindFirstChild("List", true)

local function teleportTo(targetPlayer, offset)
    local character = player.Character
    local hrp = character and character:FindFirstChild("HumanoidRootPart")
    local targetChar = targetPlayer.Character
    local targetHrp = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
    if hrp and targetHrp then
        hrp.CFrame = targetHrp.CFrame * (offset or CFrame.new(2, 0, 0))
    end
end

local function orbitPlayer(targetPlayer)
    if orbitConnection then orbitConnection:Disconnect() end
    isOrbiting = not isOrbiting
    if not isOrbiting then return end

    orbitConnection = RunService.Heartbeat:Connect(function()
        local targetHrp = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if hrp and targetHrp then
            local angle = tick() * math.pi
            local offset = Vector3.new(math.cos(angle) * 5, 0, math.sin(angle) * 5)
            hrp.CFrame = targetHrp.CFrame * CFrame.new(offset)
        end
    end)
end

local function standBehind(targetPlayer)
    if standConnection then standConnection:Disconnect() end
    standConnection = RunService.Heartbeat:Connect(function()
        if not isHiding then
            local targetHrp = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp and targetHrp then
                local pos = targetHrp.Position + Vector3.new(-1.5, 2.5, -1.5)
                hrp.CFrame = CFrame.new(pos)
            end
        end
    end)
end

local function punch()
    local tool = player.Character and player.Character:FindFirstChildOfClass("Tool")
    if tool then tool:Activate() end
end

local function hide()
    if orbitConnection then orbitConnection:Disconnect() end
    if standConnection then standConnection:Disconnect() end
    isHiding = true
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame = CFrame.new(0, 5000, 0) end
end

local function stopAll()
    if orbitConnection then orbitConnection:Disconnect() end
    if standConnection then standConnection:Disconnect() end
    isOrbiting = false
    isHiding = false
end

local function say(text)
    if SayMessageRequest then
        SayMessageRequest:FireServer(text, "All")
    end
end

local function handleCommand(cmd)
    local targetPlayer = Players:GetPlayerByUserId(commandUserId)
    if not targetPlayer then return end

    if cmd == "!bring" then
        stopAll()
        teleportTo(targetPlayer)
        say("yes king")
    elseif cmd == "!orbit" then
        stopAll()
        orbitPlayer(targetPlayer)
    elseif cmd == "!stand" then
        stopAll()
        standBehind(targetPlayer)
    elseif cmd == "!punch" then
        punch()
    elseif cmd == "!stop" then
        stopAll()
    elseif cmd == "!hide" then
        hide()
    end
end

-- CHAT WATCHER
local function watchLabel(lbl)
    if not lbl:IsA("TextLabel") then return end
    local function check()
        local txt = lbl.Text
        if txt:lower():find("!") and commandUserName and txt:lower():find(commandUserName:lower()) then
            local command = txt:match("!(%w+)")
            if command then handleCommand("!" .. command) end
        end
    end
    check()
    lbl:GetPropertyChangedSignal("Text"):Connect(check)
end

for _, desc in ipairs(list:GetDescendants()) do
    if desc:IsA("TextLabel") then watchLabel(desc) end
end

list.DescendantAdded:Connect(function(desc)
    if desc:IsA("TextLabel") then watchLabel(desc) end
end)

-- Initialize Username
local user = Players:GetPlayerByUserId(commandUserId)
if user then
    commandUserName = user.Name
else
    warn("Could not resolve username.")
end
